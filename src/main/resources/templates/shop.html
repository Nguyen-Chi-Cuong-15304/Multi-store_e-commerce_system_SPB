<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TechWorld Store - ShopOnline</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <link rel="stylesheet" href="/CSS/homepage.css">
</head>

<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark sticky-top">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-store me-2"></i>ShopOnline
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="/all/">
                            <i class="fas fa-home me-1"></i> Trang chủ
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/all/shop">
                            <i class="fas fa-store me-1"></i> Cửa hàng
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/api/cart">
                            <i class="fas fa-shopping-cart me-1"></i> Giỏ hàng
                        </a>
                    </li>

                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button"
                            data-bs-toggle="dropdown">
                            <i class="fas fa-user-circle me-1"></i> <span th:text="${fullname}"></span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li th:if="${isLoggedIn}"><a class="dropdown-item" href="/all/logout">Đăng xuất</a></li>
                            <li th:unless="${isLoggedIn}"><a class="dropdown-item" href="/all/login">Đăng nhập</a></li>
                            <li th:unless="${isLoggedIn}"><a class="dropdown-item" href="/all/register">Đăng ký</a></li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li><a class="dropdown-item" href="/all/dashboard">Trang cá nhân</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <section class="hero">
        <input type="hidden" id="shopId" name="shopId" th:value="${shopId}">
        <div class="container">
            <h1>TechWorld Store</h1>
            <p>Chuyên cung cấp các sản phẩm công nghệ chính hãng với giá cả cạnh tranh và dịch vụ chăm sóc khách hàng
                tốt nhất</p>
            <!-- <div class="search-container">
                <input type="text" class="form-control search-input" placeholder="Tìm kiếm sản phẩm...">
                <button class="search-btn"><i class="fas fa-search me-1"></i> Tìm kiếm</button>
            </div> -->
            <div class="search-container animate-fade-in-up delay-2">
                <input type="text" class="form-control search-input" placeholder="Tìm kiếm sản phẩm, cửa hàng...">
                <button class="search-btn">
                    <i class="fas fa-search me-1"></i> Tìm kiếm
                </button>
            </div>
        </div>
    </section>

    <!-- Promotional Products -->
    <section class="discount-section">
        <div class="container">
            <h2 class="section-title">Sản Phẩm Khuyến Mãi</h2>
            <div class="row">
            </div>
        </div>
    </section>

    <!-- New Products -->
    <section class="new-products-section">
        <div class="container">
            <h2 class="section-title">Sản Phẩm Mới</h2>
            <div class="row">
            </div>
        </div>
    </section>

    <!-- All Products -->
    <section class="all-section">
        <div class="container">
            <h2 class="section-title">Tất Cả Sản Phẩm</h2>
            <div class="row">
                <div class="col-lg-3 mb-4">
                    <div class="filter-box">
                        <h3 class="filter-title">Danh Mục</h3>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="cat1" checked>
                            <label class="form-check-label" for="cat1">Điện thoại & Máy tính bảng</label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="cat2">
                            <label class="form-check-label" for="cat2">Laptop & Máy tính</label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="cat3">
                            <label class="form-check-label" for="cat3">Âm thanh</label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="cat4">
                            <label class="form-check-label" for="cat4">Phụ kiện</label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="cat5">
                            <label class="form-check-label" for="cat5">Thiết bị thông minh</label>
                        </div>
                    </div>
                    <!-- <div class="filter-box">
                        <h3 class="filter-title">Khoảng Giá</h3>
                        <select class="form-select" onchange="filterByPrice(this.value)">
                            <option value="">Chọn khoảng giá</option>
                            <option value="0-5000000">Dưới 5.000.000₫</option>
                            <option value="5000000-10000000">5.000.000₫ - 10.000.000₫</option>
                            <option value="10000000-15000000">10.000.000₫ - 15.000.000₫</option>
                            <option value="15000000-20000000">15.000.000₫ - 20.000.000₫</option>
                            <option value="20000000+">Trên 20.000.000₫</option>
                        </select>
                    </div>
                    <div class="filter-box">
                        <h3 class="filter-title">Thương Hiệu</h3>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="brand1">
                            <label class="form-check-label" for="brand1">Apple</label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="brand2">
                            <label class="form-check-label" for="brand2">Samsung</label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="brand3">
                            <label class="form-check-label" for="brand3">Xiaomi</label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="brand4">
                            <label class="form-check-label" for="brand4">Sony</label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="brand5">
                            <label class="form-check-label" for="brand5">Dell</label>
                        </div>
                    </div> -->
                </div>
                <div class="col-lg-9">
                    <div class="sort-options d-flex justify-content-between align-items-center">
                        <div class="results-count">Hiển thị 1-12 của 36 sản phẩm</div>
                        <select class="form-select w-auto" onchange="sortProducts(this.value)">
                            <option value="">Sắp xếp theo</option>
                            <option value="price-asc">Giá: Thấp đến Cao</option>
                            <option value="price-desc">Giá: Cao đến Thấp</option>
                            <option value="newest">Mới nhất</option>
                            <option value="popular">Phổ biến nhất</option>
                        </select>
                    </div>
                    <div class="row">
                    </div>
                    <nav aria-label="Page navigation">
                        <ul class="pagination justify-content-center mt-4">
                            <li class="page-item active"><a class="page-link" href="#">1</a></li>
                            <li class="page-item"><a class="page-link" href="#">2</a></li>
                            <li class="page-item"><a class="page-link" href="#">3</a></li>
                            <li class="page-item"><a class="page-link" href="#">></a></li>
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="row">
                <div class="col-lg-3 col-md-6 mb-4">
                    <h5 class="footer-title">TechWorld Store</h5>
                    <p class="text-white-50">Chuyên cung cấp các sản phẩm công nghệ chính hãng với giá cả cạnh tranh.
                    </p>
                    <div class="footer-social">
                        <a href="#"><i class="fab fa-facebook-f"></i></a>
                        <a href="#"><i class="fab fa-twitter"></i></a>
                        <a href="#"><i class="fab fa-instagram"></i></a>
                        <a href="#"><i class="fab fa-youtube"></i></a>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-4">
                    <h5 class="footer-title">Liên kết nhanh</h5>
                    <ul class="footer-links">
                        <li><a href="#">Về chúng tôi</a></li>
                        <li><a href="#">Liên hệ</a></li>
                        <li><a href="#">Tuyển dụng</a></li>
                        <li><a href="#">Tin tức</a></li>
                    </ul>
                </div>
                <div class="col-lg-3 col-md-6 mb-4">
                    <h5 class="footer-title">Hỗ trợ khách hàng</h5>
                    <ul class="footer-links">
                        <li><a href="#">Trung tâm trợ giúp</a></li>
                        <li><a href="#">Hướng dẫn mua hàng</a></li>
                        <li><a href="#">Vận chuyển</a></li>
                        <li><a href="#">Đổi trả sản phẩm</a></li>
                    </ul>
                </div>
                <div class="col-lg-3 col-md-6 mb-4">
                    <h5 class="footer-title">Liên hệ</h5>
                    <ul class="footer-contact">
                        <li><i class="fas fa-map-marker-alt"></i> 123 Đường ABC, Quận 1, TP. HCM</li>
                        <li><i class="fas fa-phone"></i> (028) 3456 7890</li>
                        <li><i class="fas fa-envelope"></i> support@techworld.vn</li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="footer-bottom">
            <div class="container">
                <p class="m-0">© 2025 TechWorld Store. Tất cả quyền được bảo lưu.</p>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let allProducts = [];
        let currentPage = 1;
        const pageSize = 8; // Số sản phẩm mỗi trang

        function debounce(func, wait) {
            let timeout;
            return function (...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        document.addEventListener('DOMContentLoaded', function () {
            // Hàm xử lý lọc theo khoảng giá
            window.filterByPrice = function (range) {
                const products = document.querySelectorAll('.all-section .product-card');
                products.forEach(product => {
                    const priceText = product.querySelector('.product-price').textContent;
                    const price = parseInt(priceText.split('₫')[0].replace(/[^0-9]/g, ''));
                    let [min, max] = range.split('-').map(val => val === '+' ? Infinity : parseInt(val));
                    if (!range || (price >= min && price <= max)) {
                        product.style.display = 'block';
                    } else {
                        product.style.display = 'none';
                    }
                });
            };

            function renderShopData(data) {
                const shopName = document.querySelector('.hero .container h1');
                const shopDescription = document.querySelector('.shop-description');
                const heroSection = document.querySelector('.hero');
                if (data.linkImg) {
                    heroSection.style.backgroundImage = `linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), url(${data.linkImg})`;
                } else {
                    heroSection.style.backgroundImage = `linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), url('https://via.placeholder.com/1200x300')`;
                }
                shopName.textContent = data.shopName;
            }

            function fetchShopData() {
                let shopId = document.getElementById('shopId').value;
                shopId = parseInt(shopId);
                console.log(shopId);
                fetch('/all/get_shop_info/' + shopId, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                })
                    .then(response => response.json())
                    .then(data => {
                        console.log(data);
                        renderShopData(data);
                    })
                    .catch(error => {
                        console.error('Error fetching shop data:', error);
                    });
            }

            function fetchDiscountProducts() {
                let shopId = document.getElementById('shopId').value;
                shopId = parseInt(shopId);
                fetch('/api/discount-products/'+ shopId, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Không thể tải danh sách sản phẩm nổi bật');
                        }
                        return response.json();
                    })
                    .then(products => {
                        renderDiscountProducts(products);
                    })
                    .catch(error => {
                        console.error('Error fetching featured products:', error);
                        const featuredSection = document.querySelector('.discount-section .row');
                        featuredSection.innerHTML = '<p class="text-danger text-center">Không thể tải sản phẩm nổi bật. Vui lòng thử lại sau.</p>';
                    });
            }

            function renderDiscountProducts(products) {
                const featuredSection = document.querySelector('.discount-section .row');
                featuredSection.innerHTML = '';

                products.forEach(product => {
                    const discountedPrice = product.sellCost;
                    const ratingStars = generateRatingStars(5);
                    const productCard = `
                <div class="col-md-6 col-lg-3 mb-4">
                    <div class="product-card">
                        ${product.discount > 0 ? `<span class="discount-badge">-${(product.discount).toFixed(0)}%</span>` : ''}
                        <div class="product-img">
                            <img src="${product.linkImg || 'https://via.placeholder.com/400x300'}" alt="${product.productName}">
                        </div>
                        <div class="product-body">
                            <div class="product-store">
                                <i class="fas fa-store me-1"></i> ${product.shopName}
                            </div>
                            <h5 class="product-title">${product.productName}</h5>
                            <div class="rating">
                                ${ratingStars}
                                <span class="ms-1">(${product.viewCount})</span>
                            </div>
                            <div class="product-price">
                                ${product.discount > 0
                            ? `<span class="text-decoration-line-through text-muted me-2">${formatPrice(product.cost)}₫</span>${formatPrice(discountedPrice)}₫`
                            : `${formatPrice(product.cost)}₫`}
                            </div>
                            <div class="d-flex align-items-center">
                                <button class="btn btn-product me-2" onclick="addToCart(${product.productID})">
                                    <i class="fas fa-cart-plus me-1"></i> Thêm vào giỏ
                                </button>
                                <button class="btn btn-wishlist" onclick="addToWishlist(${product.productID})">
                                    <i class="far fa-heart"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
                    featuredSection.insertAdjacentHTML('beforeend', productCard);
                });
            }

            function fetchNewProducts() {
                let shopId = document.getElementById('shopId').value;
                shopId = parseInt(shopId);
                fetch('/api/new-products/' + shopId, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                    .then(response => response.json())
                    .then(products => {
                        renderNewProducts(products);
                    })
                    .catch(error => {
                        console.error('Error fetching new products:', error);
                    });
            }

            function renderNewProducts(products) {
                const newProductsSection = document.querySelector('.new-products-section .row');
                newProductsSection.innerHTML = '';

                products.forEach(product => {
                    const ratingStars = generateRatingStars(5);
                    const productCard = `
                <div class="col-md-6 col-lg-3 mb-4">
                    <div class="product-card">
                        <div class="product-img">
                            <img src="${product.linkImg || 'https://via.placeholder.com/400x300'}" alt="${product.productName}">
                        </div>
                        <div class="product-body">
                            <div class="product-store">
                                <i class="fas fa-store me-1"></i> ${product.shopName}
                            </div>
                            <h5 class="product-title">${product.productName}</h5>
                            <div class="rating">
                                ${ratingStars}
                                <span class="ms-1">(${product.viewCount})</span>
                            </div>
                            <div class="product-price">
                                ${formatPrice(product.cost)}₫
                            </div>
                            <div class="d-flex align-items-center">
                                <button class="btn btn-product me-2" onclick="addToCart(${product.productID})">
                                    <i class="fas fa-cart-plus me-1"></i> Thêm vào giỏ
                                </button>
                                <button class="btn btn-wishlist" onclick="addToWishlist(${product.productID})">
                                    <i class="far fa-heart"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
                    newProductsSection.insertAdjacentHTML('beforeend', productCard);
                });
            }

            function fetchAllProducts(page = 0, sort = '') {
                let shopId = parseInt(document.getElementById('shopId').value);
                url = `/api/all-products/${shopId}?page=${page}&size=${pageSize}${sort ? '&sort=' + sort : ''}`;
                if (currentCategory) {
                    url += `&categoryID=${currentCategory}`; // Thêm tham số categoryID vào URL
                }
                else {
                    // nếu không có thì truyền giá trị 0
                    url += `&categoryID=0`;
                }
                fetch(url, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        allProducts = data.content || [];
                        renderAllProducts(allProducts);
                        updatePagination(data.totalPages || 1);
                    })
                    .catch(error => {
                        console.error('Error fetching all products:', error);
                    });
            }

            function renderAllProducts(products) {
                const allProductsSection = document.querySelector('.all-section .row .row');
                allProductsSection.innerHTML = ''; // Xóa nội dung hiện tại
                products.forEach(product => {
                    const ratingStars = generateRatingStars(5);
                    const productCard = `
                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="product-card">
                        <div class="product-img">
                            <img src="${product.linkImg || 'https://via.placeholder.com/400x300'}" alt="${product.productName}">
                        </div>
                        <div class="product-body">
                            <div class="product-store">
                                <i class="fas fa-store me-1"></i> ${product.shopName}
                            </div>
                            <h5 class="product-title">${product.productName}</h5>
                            <div class="rating">
                                ${ratingStars}
                                <span class="ms-1">(${product.viewCount})</span>
                            </div>
                            <div class="product-price">
                                ${formatPrice(product.cost)}₫
                            </div>
                            <div class="d-flex align-items-center">
                                <button class="btn btn-product me-2" onclick="addToCart(${product.productID})">
                                    <i class="fas fa-cart-plus me-1"></i> Thêm vào giỏ
                                </button>
                                <button class="btn btn-wishlist" onclick="addToWishlist(${product.productID})">
                                    <i class="far fa-heart"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
                    allProductsSection.insertAdjacentHTML('beforeend', productCard);
                });
            }

            function updatePagination(totalPages) {
                const pagination = document.querySelector('.pagination');
                pagination.innerHTML = '';
                for (let i = 1; i <= totalPages; i++) {
                    const li = document.createElement('li');
                    li.className = `page-item ${i === currentPage ? 'active' : ''}`;
                    li.innerHTML = `<button class="page-link" onclick="changePage(${i})">${i}</button>`;
                    pagination.appendChild(li);
                }
            }

            window.changePage = function (page) {
                currentPage = page;
                fetchAllProducts(page - 1); // Chuyển sang index 0-based
            };

            window.addToCart = function (productId) {
                // Gửi thông tin sản phẩm đến API để thêm vào giỏ hàng
                formData = new FormData();
                formData.append('productID', productId);
                var quantity = 1; // Số lượng sản phẩm mặc định là 1
                formData.append('quantity', quantity);
                fetch('/cart/add_to_cart', {
                    method: 'POST',
                    body: formData
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Không thể thêm sản phẩm vào giỏ hàng');
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Sản phẩm đã được thêm vào giỏ hàng:', data);
                        alert(`Đã thêm sản phẩm có ID ${productId} vào giỏ hàng!`);
                    })
                    .catch(error => {
                        console.error('Error adding product to cart:', error);
                    });

                // Thêm logic gọi API để thêm sản phẩm vào giỏ hàng
            };



            window.sortProducts = debounce(function (sortOption) {
                let sortParam = '';
                if (sortOption === 'price-asc') sortParam = 'cost,asc';
                else if (sortOption === 'price-desc') sortParam = 'cost,desc';
                else if (sortOption === 'newest') sortParam = 'productID,desc';
                else if (sortOption === 'popular') sortParam = 'viewCount,desc';
                fetchAllProducts(currentPage - 1, sortParam);
            }, 300);

            function generateRatingStars(rating) {
                let stars = '';
                const fullStars = Math.floor(rating);
                const hasHalfStar = rating % 1 >= 0.5;
                for (let i = 0; i < fullStars; i++) {
                    stars += '<i class="fas fa-star"></i>';
                }
                if (hasHalfStar) {
                    stars += '<i class="fas fa-star-half-alt"></i>';
                }
                const remainingStars = 5 - Math.ceil(rating);
                for (let i = 0; i < remainingStars; i++) {
                    stars += '<i class="far fa-star"></i>';
                }
                return stars;
            }

            function formatPrice(price) {
                return price.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
            }

            function fetchCategory() {
                let shopId = document.getElementById('shopId').value;
                shopId = parseInt(shopId);
                fetch('/api/category/' + shopId, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        console.log(data);
                        renderCategory(data);
                    })
                    .catch(error => {
                        console.error('Error fetching category:', error);
                    });
            }

            function renderCategory(categories) {
                const categorySection = document.querySelector('.all-section .filter-box');
                categorySection.innerHTML = '';
                categorySection.insertAdjacentHTML('beforeend', '<h3 class="filter-title">Danh Mục</h3>');
                // Thêm select cho các danh mục
                const select = document.createElement('select');
                select.className = 'form-select mb-2';
                select.innerHTML = '<option value="">Chọn danh mục</option>';
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.categoryID;
                    option.textContent = category.categoryName;
                    select.appendChild(option);
                });
                // Gắn sự kiện onchange
                select.onchange = function () {
                    filterByCategory(this.value);
                };
                categorySection.appendChild(select);
            }

            let currentCategory = '';
            function filterByCategory(categoryID) {
                currentCategory = categoryID; // Lưu danh mục hiện tại
                currentPage = 1; // Reset về trang 1 khi lọc danh mục mới
                fetchAllProducts(0); // Gọi lại hàm fetch với trang đầu tiên
            }


            fetchShopData();
            fetchDiscountProducts();
            fetchNewProducts();
            fetchAllProducts();
            fetchCategory();
        });
    </script>
</body>

</html>